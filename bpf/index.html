<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>BPF workshops</title>

    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/black.css">

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css">

    <style>
        .left {
            text-align: left;
        }
        .reveal ul {
            display: block;
        }
        .reveal ol {
            display: block;
        }

        p.tiny {
            font-size: 0.5em;
        }

        .max600 {
            max-height: 600px !important;
        }

        .max550 {
            max-height: 550px !important;
        }

        .max500 {
            max-height: 500px !important;
        }

        .max450 {
            max-height: 450px !important;
        }

        .max300 {
            max-height: 300px !important;
        }

        .max100 {
            max-height: 100px !important;
        }

    </style>
</head>
<body>
<div class="reveal">
    <div class="slides">
        <section>
            <section data-menu-title="Intro">
                <h1><i style="text-transform: lowercase">e</i>BPF</h1>
                <h3 class="r-fit-text">wdrożenie do analizy wydajności systemów i aplikacji</h3>
                <h3>¯\_(ツ)_/¯  ->  ¯\(°_o)/¯</h3>

                <aside class="notes">
                    S - speaker mode // B - blank screen
                </aside>
            </section>

            <section data-menu-title="Quality bait">
                <h2>Przedsmak</h2>
                <p class="fragment highlight-blue">Będzie dużo teorii, sorry :'&lt;</p>
                <p>BPF == Nowa klasa aplikacji!</p>
                <p>(づ｡◕‿‿◕｡)づ Wykonujemy kod z poziomu kernela</p>
                <p>Observability, tracing, forwarding, security</p>

                <aside class="notes">
                    No bo BPF bez teorii to bezsens. On umożliwia jej wdrożenie w życie w lepszy sposób :)
                </aside>
            </section>

            <section data-menu-title="Workshop plans">
                <h2>Plan prezentacji</h2>
                <ul>
                    <li>Intro do kernela</li>
                    <li>Analiza wydajności, od zera</li>
                    <li>Zasoby systemowe i punkty pomiaru</li>
                    <li>60 second win™</li>
                    <li>BPF - ziemniaczki</li>
                    <li>BPF - mięsko</li>
                    <li>BPF - życiowe przykłady</li>
                    <li>BPF - narzędzia</li>
                </ul>
            </section>


            <section data-menu-title="End results">
                <h2>Po dzisiejszej prezentacji...</h2>
                <ul>
                    <li>Wskoczycie na hype train BPF</li>
                    <li>Zyskacie szerszy obraz deployowanych aplikacji</li>
                    <li>Poznacie systemowe narzędzia do analizy, profilowania, debugu</li>
                    <li>Kernel pozostanie blisko Waszego serca</li>
                    <li>Zyskacie dobre podstawy do dalszego samodoskonalenia</li>
                </ul>
            </section>

            <section data-menu-title="Side note">
                <p>Prezentacja mocno inspirowana materiałami Brandon'a Gregg'a m. in.</p>
                <img class="max600" src="assets/bpfperftools_bookcover_1348.png"/>
            </section>

        </section>

        <section> <!-- begin kernel -->
            <section data-menu-title="Kernel">
                <h2>Kernel</h2>
                <p class="small">µ-ankieta</p>

                <aside class="notes">
                    Quiz jak GJN. Ilu kojarzy? Ilu budowało własny? Ilu grzebało?
                </aside>
            </section>

            <section data-menu-title="Kernel overview">
                <h2>Kernel</h2>
                <img width="600" src="assets/kernel_overview.jpg"/>
                <p class="tiny">https://developer.ibm.com/articles/l-linux-kernel/ &copy;</p>


                <aside class="notes">
                    tldr; Kernel odpowiada za zarządzanie procesami i zasobami<br />
                    Wersja pełna: pamięć, czas procesora, priorytet, kolejkowanie dostępów, bla bla bla..<br />
                    Konfigurowalny (tutaj wylistować sysctl)
                </aside>
            </section>

            <section data-menu-title="Kernel internals">
                <h2>Kernel internals</h2>
                <img width="600" src="assets/kernel_internal.jpg"/>
                <p class="tiny">https://developer.ibm.com/articles/l-linux-kernel/ &copy;</p>
            </section>

            <section data-menu-title="Kernel internals - storage">
                <h2>Kernel storage</h2>
                <img width="600" src="assets/kernel_storage.jpg"/>
                <p class="tiny">https://developer.ibm.com/articles/l-linux-kernel/ &copy;</p>
            </section>

            <section data-menu-title="Kernel/user space">
                <h2>Kernel space / user space</h2>
                <img width="600" src="assets/kernel_user_space.png"/>
                <p class="tiny">https://en.wikipedia.org/wiki/User_space_and_kernel_space &copy;</p>
            </section>

            <section data-menu-title="Syscalls">
                <h3>Syscalls, grupy (approx)</h3>

                <table style="width: 150%; margin-left: -25%">
                    <thead>
                    <tr>
                        <th>Grupa</th>
                        <th>Przykłady</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr>
                        <td>Zarządzanie procesami</td>
                        <td>exec, fork, kill, mmap, futex</td>
                    </tr>
                    <tr>
                        <td>Zarządzanie plikami</td>
                        <td>open, read, rmdir</td>
                    </tr>
                    <tr>
                        <td>Zarządzanie urządzeniami</td>
                        <td>ioctl, ioperm</td>
                    </tr>
                    <tr>
                        <td>Zarządzanie "informacjami"</td>
                        <td>gethostname, getpid, clock_gettime</td>
                    </tr>
                    <tr>
                        <td>Komunikacja</td>
                        <td>pipe, send, connect, listen, dup</td>
                    </tr>
                    <tr>
                        <td>Uprawnienia</td>
                        <td>capset, chmod, chown</td>
                    </tr>
                    </tbody>
                </table>
                <small>Check out: man 2 syscalls</small>
            </section>

        </section> <!-- end kernel -->


        <section> <!-- begin performance -->

            <section data-menu-title="Performance">
                <h2>Analiza performance - intro!</h2>
                <p>Zliczanie, samplowanie, traceowanie, benchmarkowanie</p>
            </section>

            <section data-menu-title="What we have">
                <h2>Co daje nam kernel</h2>
                <ul>
                    <li>perf_event</li>
                    <li>kprobe, uprobe</li>
                    <li>tracepoint, USDT (user statically defined tracing)</li>
                    <li>PMC(performance monitoring counters)</li>
                </ul>
            </section>

            <section data-menu-title="TODO PMC">
                <h2>Liczniki sprzętowe, PMC</h2>
                <p>PMC, performance monitoring counters</p>
            </section>

            <section data-menu-title="TODO perf event">
                <h2>Perf_event</h2>
            </section>

            <section data-menu-title="Tracepoints & USDT">
                <h3>kernel tracepoints, user USDT</h3>
                <p>Kod wymaga zadeklarowania tracepointu</p>
                <p>Statyczna nazwa, statyczne argumenty</p>
                <p>W momencie kompilacji w miejscu TC znajduje się NOP(prawie zerowy narzut)</p>
                <p>Przy aktywacji TC NOP zamieniany jest na INT3</p>
                <p>Wstrzyknięta zostaje funkcja "trampolina"</p>
                <p>Po deaktywacji TC przywrócony jest NOP i usunięta trampolina</p>
                <small>https://leezhenghui.github.io/linux/2019/03/05/exploring-usdt-on-linux.html</small>
            </section>

            <section>
                <h3>Tracepoint in kernel</h3>
                <p>Przyda się za kilka slajdów :)</p>
                <pre class="c">
                    <code>
// KERNEL-6.5.0-35/include/trace/events/sched.h +372
/*
 * Tracepoint for kernel_clone:
 */
TRACE_EVENT(sched_process_fork,

        TP_PROTO(struct task_struct *parent, struct task_struct *child),

        TP_ARGS(parent, child),

        TP_STRUCT__entry(
                __array(        char,   parent_comm,    TASK_COMM_LEN   )
                __field(        pid_t,  parent_pid                      )
                __array(        char,   child_comm,     TASK_COMM_LEN   )
                __field(        pid_t,  child_pid                       )
        ),

        TP_fast_assign(
                memcpy(__entry->parent_comm, parent->comm, TASK_COMM_LEN);
                __entry->parent_pid     = parent->pid;
                memcpy(__entry->child_comm, child->comm, TASK_COMM_LEN);
                __entry->child_pid      = child->pid;
        ),

        TP_printk("comm=%s pid=%d child_comm=%s child_pid=%d",
                __entry->parent_comm, __entry->parent_pid,
                __entry->child_comm, __entry->child_pid)
);
                    </code>
                </pre>
            </section>

            <section>
                <h3>Przykład USDT</h3>
                <pre class="bash" style="width: 150%; margin-left: -25%;">
                    <code data-trim data-noescape>
rikkt0r@nasa.gov:/usr/lib$ readelf -n /lib/x86_64-linux-gnu/libc.so.6

Displaying notes found in: .note.gnu.property
  Owner                Data size        Description
  GNU                  0x00000020       NT_GNU_PROPERTY_TYPE_0
      Properties: x86 feature: IBT, SHSTK
        x86 ISA needed: x86-64-baseline

Displaying notes found in: .note.gnu.build-id
  Owner                Data size        Description
  GNU                  0x00000014       NT_GNU_BUILD_ID (unique build ID bitstring)
    Build ID: 490fef8403240c91833978d494d39e537409b92e

Displaying notes found in: .note.ABI-tag
  Owner                Data size        Description
  GNU                  0x00000010       NT_GNU_ABI_TAG (ABI version tag)
    OS: Linux, ABI: 3.2.0

Displaying notes found in: .note.stapsdt
  Owner                Data size        Description

    [...]

  stapsdt              0x0000004c       NT_STAPSDT (SystemTap probe descriptors)
    Provider: libc
    Name: pthread_start
    Location: 0x000000000009491a, Base: 0x00000000001e3e28, Semaphore: 0x0000000000000000
    Arguments: 8@%rbx 8@1600(%rbx) 8@1608(%rbx)
  stapsdt              0x00000053       NT_STAPSDT (SystemTap probe descriptors)
    Provider: libc
    Name: pthread_create
    Location: 0x000000000009511a, Base: 0x00000000001e3e28, Semaphore: 0x0000000000000000
    Arguments: 8@%rax 8@8(%rsp) 8@16(%rsp) 8@24(%rsp)
  stapsdt              0x00000031       NT_STAPSDT (SystemTap probe descriptors)
    Provider: libc
    Name: pthread_join
    Location: 0x000000000009654b, Base: 0x00000000001e3e28, Semaphore: 0x0000000000000000
    Arguments: 8@%rdi
  stapsdt              0x00000045       NT_STAPSDT (SystemTap probe descriptors)
    Provider: libc
    Name: pthread_join_ret
    Location: 0x000000000009659c, Base: 0x00000000001e3e28, Semaphore: 0x0000000000000000
    Arguments: 8@%rbx -4@%r12d 8@%r13
  stapsdt              0x00000033       NT_STAPSDT (SystemTap probe descriptors)
    Provider: libc
    Name: mutex_acquired
    Location: 0x0000000000096b4d, Base: 0x00000000001e3e28, Semaphore: 0x0000000000000000
    Arguments: 8@%rbp

    [...]

                    </code>
                </pre>
            </section>

            <section data-menu-title="kprobe, uprobe">
                <h3>kprobe, uprobe - dynamic tracing</h3>
                <p>Zapinamy się dynamicznie na funkcje kernela/aplikacji</p>
                <p>Przyjmujemy wszystkie argumenty funkcji</p>
                <p>Kod nie wymaga żadnej modyfikacji</p>
                <p>Kernel w locie patchuje adres funkcji na INT3</p>
                <p>Jeśli interrupt był z powodu k/uprobe, wykonywany jest kod probe</p>
                <p>Dla kprobe to tyle, dla uprobe tworzona jest funkcja trampolina przez którą przelatuje wątek</p>
            </section>

            <section data-menu-title="Stats & graphs magic">
                <h2>co możemy z tego ciekawego zrobić, np.</h2>
                <ul>
                    <li>Rozkład w czasie</li>
                    <li>Statystyki</li>
                    <li>Histogram</li>
                    <li>Flame graph (& chart*)</li>
                    <li>Heatmap/Flamescope</li>
                </ul>
            </section>

            <section data-menu-title="Timed diagram">
                <h2>Rozkład w czasie</h2>
                <img src="assets/timed_diagram.png" />
                <small>https://grafana.com/grafana/ example</small>
            </section>

            <section data-menu-title="Histogram">
                <h2>Histogram</h2>
                <pre class="bash">
                    <code data-trim data-noescape>
root@nasa.gov:/home/rikkt0r# runqlat.bt
Attaching 5 probes...
Tracing CPU scheduler... Hit Ctrl-C to end.
^C


@usecs:
[0]                18684 |@@@@@@@@@@@@@@@@@                                   |
[1]                56506 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[2, 4)             40787 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@               |
[4, 8)             17662 |@@@@@@@@@@@@@@@@                                    |
[8, 16)            22820 |@@@@@@@@@@@@@@@@@@@@@                               |
[16, 32)           29038 |@@@@@@@@@@@@@@@@@@@@@@@@@@                          |
[32, 64)            9437 |@@@@@@@@                                            |
[64, 128)           6672 |@@@@@@                                              |
[128, 256)          4357 |@@@@                                                |
[256, 512)          3135 |@@                                                  |
[512, 1K)           2416 |@@                                                  |
[1K, 2K)            1652 |@                                                   |
[2K, 4K)             647 |                                                    |
[4K, 8K)             220 |                                                    |
[8K, 16K)             19 |                                                    |
[16K, 32K)             1 |                                                    |

                    </code>
                </pre>
            </section>

            <section data-menu-title="Flame graph">
                <h2>Flame graph</h2>
                <img src="assets/flame_graph.svg" />
                <small>https://www.brendangregg.com/FlameGraphs/cpu-bash-flamegraph.svg</small>
            </section>

            <section data-menu-title="Flame graph 2">
                <h3>Flame graph JVM + separate kernel</h3>
                <img style="max-height: 500px;" src="assets/flame_graph_2.svg" />
                <small>https://www.brendangregg.com/FlameGraphs/example-perf.svg</small>

                <aside class="notes">
                    Flame chart == JS, w czasie
                </aside>
            </section>

            <section data-menu-title="Heatmap">
                <h2>Heatmap; Flame scope 1/3</h2>
                <img src="assets/flamescope_1.webp" />
            </section>

            <section data-menu-title="Heatmap 2">
                <h2>Heatmap; Flame scope 2/3</h2>
                <img src="assets/flamescope_2.webp" />
            </section>

            <section data-menu-title="Heatmap 3">
                <h2>Heatmap; Flame scope 3/3</h2>
                <img src="assets/flamescope_3.webp" />
            </section>

            <section>
                "USE" (Utilization Saturation Errors) method
                <img width="600" src="assets/usemethod_flow.png"/>
                <small>https://www.brendangregg.com/usemethod.html &copy;</small>
            </section>

        </section> <!-- end performance -->

        <section> <!-- begin resources -->

            <section data-menu-title="Resources">
                <h3>Zasoby mierzalne</h3>
                <p>(ciekawsze rozkminy w ramach zagrzania do BPF)</p>
                <ul>
                    <li>CPU</li>
                    <li>Pamięć</li>
                    <li>Dysk/system plików</li>
                    <li>Sieć</li>
                    <li>I inne</li>
                </ul>
            </section>

            <section data-menu-title="Side note">
                <p>Kradnę schematy z książki "BPF Performance Tools"; Brendan Gregg</p>
                <p>(Nie znalazłem ładniejszych w sieci)</p>
            </section>

            <section data-menu-title="CPU">
                <h3>CPU - stany zadań/wątków</h3>
                <img class="max500" src="assets/stolen_sorry/cpu_states.jpg" />
                <small>Shamelessly stolen from Chapter 6, BPF Performance Tools</small>
            </section>

            <section data-menu-title="CPU">
                <h3>CPU - coś niecodziennie ciekawego?</h3>
                <ul>
                    <li>Może stosy wykonań? captain obvious •_•)</li>
                    <li>Gdzie CPU przesiaduje? U usera czy w kernelu?</li>
                    <li>Jakie mamy argumenty syscalli?</li>
                    <li>Jak długo wątki się wykonują/czekają w kolejce?</li>
                    <li>Max długość kolejki?</li>
                    <li>Dla laptopów: czy procek się nie skaluje w dół?</li>
                    <li>Ezoteryka hypercomputingu - cache procesora ;) ?</li>
                </ul>
            </section>

            <section data-menu-title="Mem">
                <h3>Pamięć</h3>
                <img class="max500" src="assets/stolen_sorry/mem_allocators.jpg" />
                <small>Shamelessly stolen from Chapter 7, BPF Performance Tools</small>
            </section>

            <section data-menu-title="Mem">
                <h3>Pamięć</h3>
                <img class="max500" src="assets/stolen_sorry/mem_page_life.jpg" />
                <small>Shamelessly stolen from Chapter 7, BPF Performance Tools</small>
            </section>

            <section data-menu-title="Mem">
                <h3>Pamięć - ciekawe pytania</h3>
                <ul>
                    <li>Które procesy swapują?</li>
                    <li>Jakie stacki prowadzą do "page fault"?</li>
                    <li>A może by wykryć pamięć bez referencji? (memleak!)</li>
                    <li>Ile czasu proces czeka na odzyskanie pamięci od page cache?</li>
                    <li>Ezoteryka - podgląd zarządzania pamięcią kernela (slab model)</li>
                </ul>
            </section>

            <section data-menu-title="Network">
                <h2>Sieć</h2>
                <img class="max500" src="assets/stolen_sorry/network_stack.jpg" />
                <small>Shamelessly stolen from Chapter 10, BPF Performance Tools</small>
            </section>

            <section data-menu-title="TODO Network">
                <h3>Sieć - ciekawe pytania</h3>
                <ul>
                    <li>Problemy z L3? L4? Socketami?</li>
                    <li>Dlaczego pakiety są gubione?</li>
                    <li>Latencja TCP? Długość trwania połączenia?</li>
                    <li>Ile pakiety leżakują w kolejce?</li>
                </ul>
            </section>

            <section data-menu-title="FS - I/O stack">
                <h2>FS - stack I/O</h2>
                <img class="max500" src="assets/stolen_sorry/io_stack.jpg" />
                <small>Shamelessly stolen from Chapter 8, BPF Performance Tools</small>
            </section>

            <section data-menu-title="FS caches">
                <h2>FS - caches</h2>
                <img class="max500" src="assets/stolen_sorry/fs_caches.jpg" />
                <small>Shamelessly stolen from Chapter 8, BPF Performance Tools</small>
            </section>

            <section data-menu-title="FS">
                <h3>FS - ciekawe pytania</h3>
                <ul>
                    <li>Które procesy gdzie się odwołują?</li>
                    <li>Czasy dostępu do plików? Z jakego powodu?</li>
                    <li>Jaki mamy cache hit ratio?</li>
                    <li>Kiedy i kto czyści "dirty pages"?(tj. zapisuje dane)</li>
                    <li>Ezoteryka - prefetch (wczytaj zanim proces potrzebuje)</li>
                </ul>
            </section>

            <section data-menu-title="Block I/O - stack">
                <h3>Urządzenia blokowe - stack I/O</h3>
                <img class="max500" src="assets/stolen_sorry/bio_stack.jpg" />
                <small>Shamelessly stolen from Chapter 9, BPF Performance Tools</small>
            </section>

            <section data-menu-title="Block I/O - questions">
                <h3>Urządzenia blokowe - ciekawe pytania</h3>
                <ul>
                    <li>Jakie komendy (nvme, scsi, sata) zostały wysłane?</li>
                    <li>Ile jest i jakich zapytań do dysku?</li>
                    <li>Latencja?</li>
                    <li>Błędy? Timeouty?</li>
                    <li>Rozkład odczytów sekwencyjnych/losowych?</li>
                    <li>Ezoteryka - tym razem brak</li>
                </ul>
            </section>


            <section data-menu-title="Security">
                <h3>Security - ciekawe pytania</h3>
                <ul>
                    <li>Jaki proces gdzie się łączy?</li>
                    <li>O jakie uprawnienia proszą procesy?</li>
                    <li>Jakie błędy z braku uprawnień wystąpiły?</li>
                    <li>Trackowanie sesji PAM</li>
                    <li>Powtórka: jakie funkcje z jakimi argumentami są wykonywane?</li>
                    <li>Ezoteryka - sky is the limit</li>
                </ul>
            </section>

            <section data-menu-title="Getting there!">
                <h2>Już prawie BPF!!!!</h2>
                <p>Ostatni slajd wstępu :-)</p>
            </section>

            <section data-menu-title="Brandon 60s">
                <h2>60 second easy win by Brandon</h2>
                <pre class="bash">
                    <code data-trim data-noescape>
                        uptime
                        dmesg | tail
                        vmstat 1
                        mpstat -P ALL 1
                        pidstat 1
                        iostat -xz 1
                        free -m
                        sar -n DEV 1
                        sar -n TCP,ETCP 1
                        top
                    </code>
                </pre>
                <small class="r-fit-text">https://netflixtechblog.com/linux-performance-analysis-in-60-000-milliseconds-accc10403c55</small>

                <aside class="notes">
                    Panie admiiiiiiin<br />
                    Nie działa. Żre proca, ramu nie ma, dysk muli, sieć zwisa, kable więdną<br /><br />
                    TCPv4!<br/><br/>

                    TCP: active/s [tcpActiveOpens] CLOSED ---> SYN-SENT <br/>
                    TCP: passive/s [tcpPassiveOpens] SYN-RCVD ---> LISTEN <br/>
                    TCP: iseg/s [tcpInSegs] segments received per second (including errors) <br/>
                    TCP: oseg/s [tcpOutSegs] segments sent per second (without errors/retrans) <br/><br/>

                    ETCP: atmptf/s [tcpAttempt‐Fails]  (SYN-SENT, SYN-RCVD) ---> CLOSED + SYN-RCVD ----> LISTEN <br />
                    ETCP: estres/s [tcpEstabResets]   (ESTABLISHED, CLOSE-WAIT) ---> CLOSED <br />
                    ETCP: retrans/s [tcpRetransSegs] Num of segments retransmitted per second<br />
                    ETCP: isegerr/s [tcpInErrs] num of segments received in error (e.g., bad TCP checksums) per second<br />
                    ETCP: orsts/s [tcpOutRsts] num of TCP segments sent per second containing the RST flag
                </aside>
            </section>
        </section> <!-- end resources -->


        <section> <!-- begin bpf -->

            <section data-menu-title="BPF">
                <h2>Wreszcie czas na</h2>
                <img src="assets/ebpf_logo_glow.png" />
            </section>

            <section data-menu-title="BPF cont.">
                <h2>BPF</h2>
                <img src="assets/bpf_libbpf.png" />

                <small>Btw. jest też ebpf.pdf.exe na windowsa: https://github.com/microsoft/ebpf-for-windows</small>

                <aside class="notes">
                    Patchowanie kernela na runtime? Przez usera? Andrzej to jebnie.<br />
                    prof: perf_buffer copy to userspace ---> BPF: final value to userspace (statistics, chart)
                    <br />
                    --f-no-omit-frame-pointer is love
                </aside>
            </section>

            <section data-menu-title="BPF cont.">
                <h2>BPF Verifier</h2>
                <img src="assets/bpf_loader.png" />
            </section>

            <section data-menu-title="Alternatives">
                <h4>Ale przecie istnieją już narzędzia do profilowania/traecingu?</h4>
                <p class="fragment fade-in-then-semi-out">No tak...</p>
                <p>
                    <span class="fragment fade-in-then-semi-out">ftrace</span>
                    <span class="fragment fade-in-then-semi-out">perf</span>
                    <span class="fragment fade-in-then-semi-out">systemTap</span>
                    <span class="fragment fade-in-then-semi-out">LTTng</span>
                    <span class="fragment fade-in-then-semi-out">Dtrace</span>
                </p>
                <p class="fragment fade-in-then-semi-out">...ale:</p>
                <p class="fragment fade-in-then-semi-out">Są na poziomie user space (skrót myślowy)</p>
                <p class="fragment fade-in-then-semi-out">BPF umie więcej niż tylko tracing</p>
                <p class="fragment fade-in-then-semi-out">BPF umi szybciej</p>
                <p class="fragment fade-in-then-semi-out r-fit-text">Narzędzia BPF korzystają z dorobku intelektualnego powyższych</p>
                <p class="fragment fade-in-then-semi-out">Optymalne BPF'owe bajery!</p>

                <aside class="notes">
                    bajery == mapy w pamięci kernela
                </aside>
            </section>

            <section data-menu-title="BCC, BPFTrace">
                <h2>Front-end BPF</h2>
                <p>Czyste C</p>
                <p>BCC</p>
                <p>BPFTrace</p>
            </section>

            <section data-menu-title="TODO BCC">
                <h2>BCC</h2>
                <p>Wstawić schemat</p>
            </section>

            <section data-menu-title="TODO BPFtrace">
                <h2>BPFtrace</h2>
                <p>Front end BPF</p>
                <p>Platforma && język programowania do traceingu</p>
                <p>schemat tutaj???</p>
            </section>

            <section data-menu-title="TODO BPFtrace">
                <h2>BPFtrace</h2>
                <pre>
BEGIN
{
	printf("Tracing block device I/O... Hit Ctrl-C to end.\n");
}

tracepoint:block:block_bio_queue
{
	@start[args.sector] = nsecs;
}

tracepoint:block:block_rq_complete,
tracepoint:block:block_bio_complete
/@start[args.sector]/
{
	@usecs = hist((nsecs - @start[args.sector]) / 1000);
	delete(@start[args.sector]);
}

END
{
	clear(@start);
}
                </pre>
                <small>https://github.com/bpftrace/bpftrace/blob/master/tools/biolatency.bt</small>
            </section>

            <section data-menu-title="Typy programów bpf">
                <h2>Typy programów BPF</h2>
                <pre>
BPF map types = {
    // more @ /usr/include/linux/bpf.h

    BPF_MAP_TYPE_ARRAY,
    BPF_MAP_TYPE_ARRAY_OF_MAPS,
    BPF_MAP_TYPE_CGROUP_ARRAY,
    BPF_MAP_TYPE_CGROUP_STORAGE,
    // ...
    BPF_MAP_TYPE_LRU_HASH,
    BPF_MAP_TYPE_LRU_PERCPU_HASH,
    // ...
    BPF_MAP_TYPE_QUEUE,
    BPF_MAP_TYPE_REUSEPORT_SOCKARRAY,
    BPF_MAP_TYPE_SOCKHASH,
    BPF_MAP_TYPE_SOCKMAP,
    BPF_MAP_TYPE_STACK,
    BPF_MAP_TYPE_STACK_TRACE,
    BPF_MAP_TYPE_UNSPEC,  // Reserved, invalid
    BPF_MAP_TYPE_XSKMAP,
};
                </pre>
            </section>

            <section data-menu-title="TODO inne">
                <p>
            BPF - struktury w C - dostęp do nich,
            bpftrace (w tym jezyk) vs bcc
            dostępne mapy w pamięci
                </p>

            </section>

        </section> <!-- end bpf -->


        <section> <!-- begin examples -->

            <section data-menu-title="Stories">
                <h2>Kilka życiowych przypadków</h2>
                <p class="fragment">(życiowych dla mnie)</p>
            </section>

            <section data-menu-title="File access">
                <h3>Brakuje jakiegoś pliku np. konfiguracyjnego</h3>
                <p>Live: opensnoop + missing.py</p>
            </section>

            <section data-menu-title="TODO Short lived task">
                <h2>Short lived task</h2>
                <p>Live: top vs. execsnoop</p>
            </section>

            <section data-menu-title="TODO Timeout on jenkins job">
                <h2>Timeout na jobie jenkinsowym</h2>
                <p class="fragment">Pomysły??</p>
                <p class="fragment">Odpalamy ....</p>
                <p class="fragment">O... ścieżka do unix socket ma ograniczenie na 108 znaków :)</p>

                <p></p>
            </section>

            <section data-menu-title="TODO Python GIL psycopg">
                <h2>lock na postgresie</h2>
            </section>

            <section data-menu-title="TODO Overscalling!">
                <h2>Więcej == lepiej??</h2>
                <p class="fragment fade-in-then-semi-out">Więcej procesów FCGI/WSGI == szybciej, lepiej?</p>
                <p class="fragment fade-in-then-semi-out">Sprawdźmy :-)</p>
                <pre class="bash">
                    <code>
la la la
                    </code>
                </pre>
            </section>

            <section data-menu-title="TODO DNS hang">
                <h2>apka wisi i uj wi na co czeka (tutaj bpf do dnsów się kłania)F</h2>
            </section>

            <section data-menu-title="Intrusive admin :)">
                <h2>Adminowa zabawa - podglądanie shella</h2>
                <p>(lub zabieg security, cokolwiek by lepiej nie brzmiało)</p>
                <p>Live: Bash readline && bash snooping</p>

                <pre class="bpf">
                    <code>
BEGIN
{
        printf("Tracing bash commands... Hit Ctrl-C to end.\n");
        printf("%-9s %-6s %s\n", "TIME", "PID", "COMMAND");
}

uretprobe:/bin/bash:readline
{
        time("%H:%M:%S  ");
        printf("%-6d %s\n", pid, str(retval));
}

                    </code>
                </pre>

                <aside class="notes">
                    bashreadline.bt <br />
                    shellsnoop.bt (heh, źle przepisałem, copyright Brendan)<br />
                    shellsnoop_fixed.bt<br />
                    grep -r sched_process_fork /usr/src/linux-hwe-6.5-headers-6.5.0-35
                </aside>
            </section>

            <section data-menu-title="Cilium">
                <h2>Cilium + TCP Splicing</h2>
                <p>firma Rudego - L7 scaller</p>
            </section>
        </section> <!-- end examples -->


        <section>
            <section data-menu-title="BPF Tools">
                <h2>BPF Tools ┬─┬ ︵ /(.□. \）</h2>
                <pre class="bash">
                    <code data-trim data-noescape>
rikkt0r@xyz:/usr/sbin$ ls *-bpfcc
argdist-bpfcc         javaflow-bpfcc        runqlen-bpfcc
bashreadline-bpfcc    javagc-bpfcc          runqslower-bpfcc
bindsnoop-bpfcc       javaobjnew-bpfcc      shmsnoop-bpfcc
biolatency-bpfcc      javastat-bpfcc        slabratetop-bpfcc
biolatpcts-bpfcc      javathreads-bpfcc     sofdsnoop-bpfcc
biosnoop-bpfcc        killsnoop-bpfcc       softirqs-bpfcc
biotop-bpfcc          klockstat-bpfcc       solisten-bpfcc
bitesize-bpfcc        llcstat-bpfcc         sslsniff-bpfcc
bpflist-bpfcc         mdflush-bpfcc         stackcount-bpfcc
btrfsdist-bpfcc       memleak-bpfcc         statsnoop-bpfcc
btrfsslower-bpfcc     mountsnoop-bpfcc      swapin-bpfcc
cachestat-bpfcc       mysqld_qslower-bpfcc  syncsnoop-bpfcc
cachetop-bpfcc        netqtop-bpfcc         syscount-bpfcc
capable-bpfcc         nfsdist-bpfcc         tclcalls-bpfcc
cobjnew-bpfcc         nfsslower-bpfcc       tclflow-bpfcc
compactsnoop-bpfcc    nodegc-bpfcc          tclobjnew-bpfcc
cpudist-bpfcc         nodestat-bpfcc        tclstat-bpfcc
cpuunclaimed-bpfcc    offcputime-bpfcc      tcpaccept-bpfcc
criticalstat-bpfcc    offwaketime-bpfcc     tcpconnect-bpfcc
dbslower-bpfcc        oomkill-bpfcc         tcpconnlat-bpfcc
dbstat-bpfcc          opensnoop-bpfcc       tcpdrop-bpfcc
dcsnoop-bpfcc         perlcalls-bpfcc       tcplife-bpfcc
dcstat-bpfcc          perlflow-bpfcc        tcpretrans-bpfcc
deadlock-bpfcc        perlstat-bpfcc        tcprtt-bpfcc
dirtop-bpfcc          phpcalls-bpfcc        tcpstates-bpfcc
drsnoop-bpfcc         phpflow-bpfcc         tcpsubnet-bpfcc
execsnoop-bpfcc       phpstat-bpfcc         tcpsynbl-bpfcc
exitsnoop-bpfcc       pidpersec-bpfcc       tcptop-bpfcc
ext4dist-bpfcc        profile-bpfcc         tcptracer-bpfcc
ext4slower-bpfcc      pythoncalls-bpfcc     threadsnoop-bpfcc
filelife-bpfcc        pythonflow-bpfcc      tplist-bpfcc
fileslower-bpfcc      pythongc-bpfcc        trace-bpfcc
filetop-bpfcc         pythonstat-bpfcc      ttysnoop-bpfcc
funccount-bpfcc       readahead-bpfcc       vfscount-bpfcc
funcinterval-bpfcc    reset-trace-bpfcc     vfsstat-bpfcc
funclatency-bpfcc     rubycalls-bpfcc       wakeuptime-bpfcc
funcslower-bpfcc      rubyflow-bpfcc        xfsdist-bpfcc
gethostlatency-bpfcc  rubygc-bpfcc          xfsslower-bpfcc
hardirqs-bpfcc        rubyobjnew-bpfcc      zfsdist-bpfcc
inject-bpfcc          rubystat-bpfcc        zfsslower-bpfcc
javacalls-bpfcc       runqlat-bpfcc


rikkt0r@xyz:/usr/sbin$ ls *.bt
bashreadline.bt    mdflush.bt    tcpaccept.bt
biolatency.bt      naptime.bt    tcpconnect.bt
biosnoop.bt        oomkill.bt    tcpdrop.bt
biostacks.bt       opensnoop.bt  tcplife.bt
bitesize.bt        pidpersec.bt  tcpretrans.bt
capable.bt         runqlat.bt    tcpsynbl.bt
cpuwalk.bt         runqlen.bt    threadsnoop.bt
dcsnoop.bt         setuids.bt    vfscount.bt
execsnoop.bt       statsnoop.bt  vfsstat.bt
gethostlatency.bt  swapin.bt     writeback.bt
killsnoop.bt       syncsnoop.bt  xfsdist.bt
loads.bt           syscount.bt


# Nie jest to BPF
#  ale chciałem pokazać przodków tych narzędzi :)

rikkt0r@xyz:/usr/sbin$ ls *-perf
bitesize-perf    functrace-perf  perf-stat-hist-perf
cachestat-perf   iolatency-perf  reset-ftrace-perf
execsnoop-perf   iosnoop-perf    syscount-perf
funccount-perf   killsnoop-perf  tcpretrans-perf
funcgraph-perf   kprobe-perf     tpoint-perf
funcslower-perf  opensnoop-perf  uprobe-perf
                    </code>
                </pre>
            </section>

            <section data-menu-title="BPF Tools Gregg">
                <img src="assets/bpf_performance_tools_book.png" />
            </section>
        </section>

        <section>
            <h2>The end; &copy; rikkt0r; @:priv@asap.solutions</h2>
            <p>(づ｡◕‿‿◕｡)づ Bibliography</p>
            <ol>
                <li>
                    <a href="https://www.brendangregg.com/bpf-performance-tools-book.html"
                       target="_blank">[BPF Performance Tools]</a>
                </li>
                <li>
                    <a href="https://ebpf.io/" target="_blank">[eBPF.io]</a>
                </li>
                <li>
                    <a href="https://www.youtube.com/watch?v=Wb_vD3XZYOA" target="_blank">[BPF Thriller Document]</a>
                </li>
                <li>
                    <a class="r-fit-text" href="https://www.slideshare.net/slideshow/usenix-atc-2017-visualizing-performance-with-flame-graphs/77852774" target="_blank">
                        [USENIX ATC 2017: Visualizing Performance with Flame Graphs]
                    </a>
                </li>
                <li>
                    <a class="r-fit-text" href="https://www.slideshare.net/slideshow/flamescope-2018/122582735" target="_blank">
                        [FlameScope 2018; Brendan Gregg]
                    </a>
                </li>
                <li>Any other material from Gregg, lol</li>
                <li>&& you best friend, manpages</li>
            </ol>
        </section>
    </div>
</div>

<script src="dist/reveal.js"></script>
<script src="plugin/notes/notes.js"></script>
<script src="plugin/markdown/markdown.js"></script>
<script src="plugin/highlight/highlight.js"></script>
<script src="plugin/menu/menu.js"></script>
<script>
    // More info about initialization & config:
    // - https://revealjs.com/initialization/
    // - https://revealjs.com/config/
    Reveal.initialize({
        hash: true,

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealMenu ]
    });


</script>
</body>
</html>
